<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office 365 è®¢é˜…ç›‘æ§</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <span style="font-size: 1.5rem;">ğŸ“Š</span> Office 365 è®¢é˜…ç›‘æ§
            </span>
            <div class="d-flex">
                <a href="/" class="btn btn-light btn-sm me-2">
                    <span>ğŸ </span> ä»ªè¡¨æ¿
                </a>
                <a href="/settings" class="btn btn-outline-light btn-sm me-2">
                    <span>âš™ï¸</span> è®¾ç½®
                </a>
                <a href="/logout" class="btn btn-outline-light btn-sm">
                    <span>ğŸšª</span> ç™»å‡º
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">ğŸ“‹ è®¢é˜…çŠ¶æ€</h2>
                <p class="text-muted mb-0">å®æ—¶ç›‘æ§æ‚¨çš„ Office 365 è®¢é˜…</p>
            </div>
            <div>
                <button class="btn btn-success btn-lg me-2" data-bs-toggle="modal" data-bs-target="#createUserModal" style="border-radius: 12px;">
                    <span>ğŸ‘¤</span> åˆ›å»ºç”¨æˆ·
                </button>
                <button class="btn btn-primary btn-lg" onclick="refreshAll()" style="border-radius: 12px;">
                    <span id="refreshIcon">ğŸ”„</span> åˆ·æ–°å…¨éƒ¨
                </button>
            </div>
        </div>

        <div id="subscriptionsContainer" class="row">
            <!-- è®¢é˜…å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div id="emptyState" class="text-center py-5" style="display: none;">
            <p class="text-muted">æš‚æ— è®¢é˜…é¡¹ï¼Œè¯·å‰å¾€<a href="/settings">è®¾ç½®é¡µé¢</a>æ·»åŠ </p>
        </div>
    </div>

    <!-- æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨æ¨¡æ€æ¡† -->
    <div class="modal fade" id="viewUsersModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewUsersTitle">ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨</h5>
                    <div>
                        <button type="button" class="btn btn-info btn-sm me-2" id="queryAllActivationBtn" 
                                onclick="queryAllActivation()" style="border-radius: 8px;">
                            ğŸ“± æŸ¥è¯¢æ‰€æœ‰æ¿€æ´»
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="usersLoadingState" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-3 text-muted">æ­£åœ¨åŠ è½½ç”¨æˆ·åˆ—è¡¨...</p>
                    </div>
                    <div id="usersListContainer" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>æ˜¾ç¤ºåç§°</th>
                                        <th>é‚®ç®±</th>
                                        <th>è®¸å¯è¯</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div id="usersTotalCount" class="text-muted mt-3"></div>
                    </div>
                    <div id="usersErrorState" class="alert alert-danger" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰€æœ‰ç”¨æˆ·æ¿€æ´»ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="allActivationModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allActivationTitle">ğŸ“± æ‰€æœ‰ç”¨æˆ· Office 365 æ¿€æ´»ä¿¡æ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="allActivationLoadingState" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-3 text-muted">æ­£åœ¨æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·æ¿€æ´»ä¿¡æ¯ï¼Œè¯·ç¨å€™...</p>
                    </div>
                    <div id="allActivationContent" style="display: none;">
                        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card text-center bg-light">
                                    <div class="card-body">
                                        <h3 class="mb-1 text-success" id="allTotalUsers">0</h3>
                                        <small class="text-muted">æœ‰æ¿€æ´»çš„ç”¨æˆ·</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center bg-light">
                                    <div class="card-body">
                                        <h3 class="mb-1 text-primary" id="allTotalComputers">0</h3>
                                        <small class="text-muted">æ€»æ¿€æ´»ç”µè„‘</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center bg-light">
                                    <div class="card-body">
                                        <h3 class="mb-1 text-info" id="allTotalDevices">0</h3>
                                        <small class="text-muted">æ€»æ¿€æ´»è®¾å¤‡</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç”¨æˆ·æ¿€æ´»åˆ—è¡¨ -->
                        <div id="allActivationList"></div>
                    </div>
                    <div id="allActivationErrorState" class="alert alert-danger" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¿€æ´»ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="activationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="activationTitle">ğŸ“± Office 365 æ¿€æ´»ä¿¡æ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="activationLoadingState" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-3 text-muted">æ­£åœ¨æŸ¥è¯¢æ¿€æ´»ä¿¡æ¯...</p>
                    </div>
                    <div id="activationContent" style="display: none;">
                        <!-- ç”¨æˆ·ä¿¡æ¯ -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>æ˜¾ç¤ºåç§°:</strong> <span id="actUserName"></span></p>
                                        <p class="mb-0"><strong>é‚®ç®±:</strong> <span id="actUserEmail"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ¿€æ´»ç»Ÿè®¡ -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">ğŸ’» è®¾å¤‡æ¿€æ´»æƒ…å†µ</h6>
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="p-3 bg-light rounded">
                                            <h4 class="mb-1"><span id="actComputers"></span></h4>
                                            <small class="text-muted">ç”µè„‘</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-3 bg-light rounded">
                                            <h4 class="mb-1"><span id="actDevices"></span></h4>
                                            <small class="text-muted">ç§»åŠ¨è®¾å¤‡</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è®¾å¤‡åˆ—è¡¨ -->
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">ğŸ“‹ è®¾å¤‡åˆ—è¡¨</h6>
                                <div id="machinesList"></div>
                            </div>
                        </div>
                    </div>
                    <div id="activationErrorState" class="alert alert-danger" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ‘¤ åˆ›å»º Office 365 ç”¨æˆ·</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="mb-3">
                            <label for="userSubscription" class="form-label">é€‰æ‹©è®¢é˜…</label>
                            <select class="form-select" id="userSubscription" required>
                                <option value="">è¯·é€‰æ‹©è®¢é˜…...</option>
                            </select>
                            <div class="form-text">é€‰æ‹©è¦åœ¨å“ªä¸ªè®¢é˜…ä¸­åˆ›å»ºç”¨æˆ·</div>
                        </div>
                        <div class="mb-3">
                            <label for="username" class="form-label">ç”¨æˆ·å</label>
                            <input type="text" class="form-control" id="username" required 
                                   placeholder="ä¾‹å¦‚: zhangsan">
                            <div class="form-text">ç”¨æˆ·çš„ç™»å½•åï¼ˆä¸å«åŸŸåï¼‰</div>
                        </div>
                        <div class="mb-3">
                            <label for="userPassword" class="form-label">å¯†ç ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" class="form-control" id="userPassword" 
                                   placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆéšæœºå¯†ç ">
                            <div class="form-text">å¦‚æœä¸å¡«å†™ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆ12ä½éšæœºå¯†ç </div>
                        </div>
                        <div class="alert alert-info mb-0">
                            <strong>ğŸ’¡ æç¤ºï¼š</strong>
                            <ul class="mb-0">
                                <li>ç”¨æˆ·å°†ä½¿ç”¨è®¢é˜…é…ç½®çš„åŸŸå</li>
                                <li>è‡ªåŠ¨åˆ†é…è®¢é˜…ä¸­é…ç½®çš„è®¸å¯è¯</li>
                                <li>åˆ›å»ºåéœ€è¦é¦–æ¬¡ç™»å½•æ—¶ä¿®æ”¹å¯†ç </li>
                            </ul>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-success" onclick="createUser()">
                        <span>âœ…</span> åˆ›å»ºç”¨æˆ·
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šç”¨é€šçŸ¥æ¨¡æ€æ¡† -->
    <div class="modal fade" id="notificationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" id="notificationHeader">
                    <h5 class="modal-title" id="notificationTitle">é€šçŸ¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="notificationBody">
                    <!-- é€šçŸ¥å†…å®¹ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºç”¨æˆ·ç»“æœæ¨¡æ€æ¡† -->
    <div class="modal fade" id="userResultModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        <strong>ğŸ‰ æ­å–œï¼</strong> ç”¨æˆ·å·²æˆåŠŸåˆ›å»ºï¼Œè¯·å¦¥å–„ä¿ç®¡ä»¥ä¸‹ä¿¡æ¯ã€‚
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">ğŸ‘¤ ç”¨æˆ·å</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="resultUsername" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('resultUsername')">
                                ğŸ“‹ å¤åˆ¶
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">ğŸ“§ é‚®ç®±åœ°å€</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="resultEmail" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('resultEmail')">
                                ğŸ“‹ å¤åˆ¶
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">ğŸ”‘ å¯†ç </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="resultPassword" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('resultPassword')">
                                ğŸ“‹ å¤åˆ¶
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">ğŸ“‹ è®¸å¯è¯</label>
                        <input type="text" class="form-control" id="resultLicense" readonly>
                    </div>
                    
                    <div class="alert alert-warning mb-0">
                        <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong>
                        <ul class="mb-0 mt-2">
                            <li>è¯·ç«‹å³å¤åˆ¶å¹¶ä¿å­˜å¯†ç ä¿¡æ¯</li>
                            <li>å…³é—­æ­¤çª—å£åå°†æ— æ³•å†æ¬¡æŸ¥çœ‹å¯†ç </li>
                            <li>é¦–æ¬¡ç™»å½•æ—¶éœ€è¦ä¿®æ”¹å¯†ç </li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="copyAllUserInfo()">
                        ğŸ“‹ å¤åˆ¶å…¨éƒ¨ä¿¡æ¯
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // é¡µé¢åŠ è½½æ—¶è·å–è®¢é˜…åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', function() {
            loadSubscriptions();
        });

        function loadSubscriptions() {
            fetch('/api/subscriptions')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        displaySubscriptions(result.data);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½è®¢é˜…å¤±è´¥:', error);
                });
        }

        function displaySubscriptions(subscriptions) {
            const container = document.getElementById('subscriptionsContainer');
            const emptyState = document.getElementById('emptyState');

            if (subscriptions.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = subscriptions.map(sub => createSubscriptionCard(sub)).join('');
        }

        function createSubscriptionCard(sub) {
            const data = sub.subscription_data || {};
            const status = sub.status || 'unknown';
            const errorType = sub.error_type || '';
            const daysRemaining = sub.days_remaining || 0;
            const usagePercentage = sub.usage_percentage || 0;
            
            // çŠ¶æ€å›¾æ ‡å’Œé¢œè‰²
            let statusIcon = 'â“';
            let statusText = 'æœªçŸ¥';
            let statusBadge = 'bg-secondary';
            
            if (status === 'active') {
                statusIcon = 'âœ…';
                statusText = 'æ´»è·ƒ';
                statusBadge = 'bg-success';
            } else if (status === 'expired') {
                statusIcon = 'âŒ';
                statusText = 'å¤±æ•ˆ';
                statusBadge = 'bg-danger';
            } else if (status === 'error') {
                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„çŠ¶æ€
                if (errorType === 'auth_failure' || errorType === 'network_error' || errorType === 'timeout') {
                    statusIcon = 'ğŸ”‘';
                    statusText = 'Cookie è¿‡æœŸ';
                    statusBadge = 'bg-danger';
                } else {
                    statusIcon = 'âš ï¸';
                    statusText = 'é”™è¯¯';
                    statusBadge = 'bg-warning';
                }
            }

            // ä½¿ç”¨ç‡é¢œè‰²
            const usageClass = usagePercentage >= 80 ? 'bg-danger' : 'bg-primary';
            
            // åˆ°æœŸè­¦å‘Š
            const expirationWarning = (daysRemaining > 0 && daysRemaining <= 30) ? 
                '<span class="badge bg-warning text-dark ms-2">â° å³å°†åˆ°æœŸ</span>' : '';
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            const expirationDate = data.expirationDate ? 
                new Date(data.expirationDate).toLocaleDateString('zh-CN') : 'æœªçŸ¥';
            
            // ä¸Šæ¬¡æ£€æµ‹æ—¶é—´
            const lastCheckTime = sub.last_check_time ? 
                new Date(sub.last_check_time).toLocaleString('zh-CN') : 'ä»æœªæ£€æµ‹';

            // è®¢é˜…ç±»å‹æ˜¾ç¤ºï¼ˆä¼˜å…ˆä½¿ç”¨ name å­—æ®µï¼‰
            const subscriptionType = data.name || data.skuPartNumber || sub.name;
            
            // å¤šè®¸å¯è¯æ ‡è¯†
            const isMultiLicense = data.is_multi_license || false;
            const multiLicenseInfo = data.multi_license_info || null;
            
            // å¤šè®¸å¯è¯å¾½ç« 
            const multiLicenseBadge = isMultiLicense ? 
                `<span class="badge bg-info ms-2" style="font-size: 0.85rem; padding: 0.4rem 0.6rem;">
                    ğŸ”— ${multiLicenseInfo.subscription_count}ä¸ªè®¢é˜…
                </span>` : '';

            return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 subscription-card shadow-sm ${isMultiLicense ? 'border-info' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2 flex-wrap">
                                        <span class="badge bg-dark me-2" style="font-size: 0.9rem; padding: 0.5rem 0.75rem;">
                                            #${sub.order || 0}
                                        </span>
                                        <span class="badge ${statusBadge}" style="font-size: 0.9rem; padding: 0.5rem 0.75rem;">
                                            ${statusIcon} ${statusText}
                                        </span>
                                        ${multiLicenseBadge}
                                    </div>
                                    <h5 class="card-title mb-0">${sub.name}</h5>
                                </div>
                                <div>
                                    ${sub.user_create_config ? `
                                    <button class="btn btn-sm btn-info me-2" onclick="viewUsers('${sub.id}', '${sub.name}')" 
                                            style="border-radius: 8px;">
                                        ğŸ‘¥ ç”¨æˆ·
                                    </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-primary" onclick="checkSubscription('${sub.id}')" 
                                            style="border-radius: 8px;">
                                        ğŸ” æ£€æµ‹
                                    </button>
                                </div>
                            </div>

                            <div class="mb-3 p-3 bg-light rounded">
                                <div class="d-flex align-items-center">
                                    <span style="font-size: 1.5rem; margin-right: 0.5rem;">ğŸ“¦</span>
                                    <div class="flex-grow-1">
                                        <small class="text-muted d-block">è®¢é˜…ç±»å‹</small>
                                        <strong>${subscriptionType}</strong>
                                        ${isMultiLicense ? `
                                        <div class="mt-2">
                                            <small class="text-info">
                                                <strong>ğŸ’¡ å¤šè®¸å¯è¯è´¦å·</strong><br>
                                                æ¯ä¸ªè®¢é˜… ${multiLicenseInfo.licenses_per_subscription} ä¸ªè®¸å¯è¯ Ã— ${multiLicenseInfo.subscription_count} = ${data.totalLicenses} ä¸ª
                                            </small>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span><strong>ğŸ“Š è®¸å¯è¯ä½¿ç”¨</strong></span>
                                    <span class="badge bg-secondary">${data.consumedUnits || 0} / ${data.totalLicenses || 0}</span>
                                </div>
                                <div class="progress" style="height: 24px; border-radius: 12px;">
                                    <div class="progress-bar ${usageClass}" role="progressbar" 
                                         style="width: ${usagePercentage}%;" 
                                         aria-valuenow="${usagePercentage}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        <strong>${usagePercentage}%</strong>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3 p-3 border rounded">
                                <div class="d-flex align-items-center mb-2">
                                    <span style="font-size: 1.2rem; margin-right: 0.5rem;">ğŸ“…</span>
                                    <strong>åˆ°æœŸä¿¡æ¯</strong>
                                    ${expirationWarning}
                                </div>
                                <div class="ms-4">
                                    <p class="mb-1 small">åˆ°æœŸæ—¥æœŸ: <strong>${expirationDate}</strong></p>
                                    <p class="mb-0 small ${daysRemaining <= 30 ? 'text-warning fw-bold' : ''}">
                                        å‰©ä½™å¤©æ•°: <strong>${daysRemaining} å¤©</strong>
                                    </p>
                                </div>
                            </div>

                            ${isMultiLicense ? `
                            <div class="mb-3">
                                <button class="btn btn-sm btn-outline-info w-100" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#multiLicense${sub.id}" 
                                        style="border-radius: 8px;">
                                    ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰è®¢é˜…è¯¦æƒ…
                                </button>
                                <div class="collapse mt-2" id="multiLicense${sub.id}">
                                    <div class="card card-body bg-light">
                                        <small class="text-muted mb-2"><strong>è®¢é˜…åˆ—è¡¨ï¼š</strong></small>
                                        ${multiLicenseInfo.subscriptions.map((subDetail, idx) => {
                                            const subExpDate = subDetail.expiration_date ? 
                                                new Date(subDetail.expiration_date).toLocaleDateString('zh-CN') : 'æœªçŸ¥';
                                            const subStartDate = subDetail.start_date ? 
                                                new Date(subDetail.start_date).toLocaleDateString('zh-CN') : 'æœªçŸ¥';
                                            return `
                                                <div class="p-2 mb-2 bg-white rounded border">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div>
                                                            <small><strong>è®¢é˜… ${idx + 1}</strong></small><br>
                                                            <small class="text-muted">è®¸å¯è¯: ${subDetail.licenses} ä¸ª</small><br>
                                                            <small class="text-muted">å¼€å§‹: ${subStartDate}</small><br>
                                                            <small class="text-muted">åˆ°æœŸ: ${subExpDate}</small>
                                                        </div>
                                                        <span class="badge bg-secondary" style="font-size: 0.7rem;">
                                                            ID: ${subDetail.id.substring(0, 8)}...
                                                        </span>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                            ` : ''}

                            <div class="border-top pt-2 mt-3">
                                <small class="text-muted">
                                    <span>ğŸ•</span> ä¸Šæ¬¡æ£€æµ‹: ${lastCheckTime}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function checkSubscription(subId) {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'æ£€æµ‹ä¸­...';

            fetch(`/api/subscriptions/${subId}/check`, {
                method: 'POST'
            })
            .then(response => {
                // å…ˆæ£€æŸ¥çŠ¶æ€ç 
                if (response.status === 400) {
                    // å°è¯•è§£æ JSONï¼Œå¦‚æœå¤±è´¥è¯´æ˜ Cookie è¿‡æœŸ
                    return response.text().then(text => {
                        try {
                            const result = JSON.parse(text);
                            return { success: false, isCookieExpired: true, error: result.error || result.message || 'Cookie å·²è¿‡æœŸ' };
                        } catch (e) {
                            return { success: false, isCookieExpired: true, error: 'Cookie å·²è¿‡æœŸï¼Œè¯·æ›´æ–°' };
                        }
                    });
                }
                return response.json();
            })
            .then(result => {
                btn.disabled = false;
                btn.textContent = 'ğŸ” æ£€æµ‹';
                
                if (result.success) {
                    showNotification('æ£€æµ‹å®Œæˆ', 'è®¢é˜…çŠ¶æ€å·²æ›´æ–°', 'success');
                    loadSubscriptions();
                } else {
                    const errorMsg = result.isCookieExpired 
                        ? `ğŸ”‘ ${result.error}\n\nè¯·å‰å¾€è®¾ç½®é¡µé¢æ›´æ–°æ­¤è®¢é˜…çš„ Cookie`
                        : result.message || result.error;
                    showNotification('æ£€æµ‹å¤±è´¥', errorMsg, 'danger');
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.textContent = 'ğŸ” æ£€æµ‹';
                // ç½‘ç»œé”™è¯¯ä¹Ÿå¯èƒ½æ˜¯ Cookie è¿‡æœŸå¯¼è‡´çš„
                const errorMsg = error.message.includes('Expecting value') || error.message.includes('JSON')
                    ? 'ğŸ”‘ Cookie å·²è¿‡æœŸæˆ–æ— æ•ˆ\n\nè¯·å‰å¾€è®¾ç½®é¡µé¢æ›´æ–°æ­¤è®¢é˜…çš„ Cookie'
                    : `ç½‘ç»œé”™è¯¯: ${error.message}`;
                showNotification('æ£€æµ‹å¤±è´¥', errorMsg, 'danger');
            });
        }

        function refreshAll() {
            const icon = document.getElementById('refreshIcon');
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>æ£€æµ‹ä¸­...';
            icon.style.animation = 'spin 1s linear infinite';
            
            // è·å–æ‰€æœ‰è®¢é˜…
            fetch('/api/subscriptions')
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data.length > 0) {
                        // é€ä¸ªæ£€æµ‹è®¢é˜…ï¼Œä¼ å…¥ç»“æœæ”¶é›†å¯¹è±¡
                        checkSubscriptionsSequentially(result.data, 0, btn, originalText, icon, {
                            success: [],
                            failed: []
                        });
                    } else {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        icon.style.animation = '';
                        showNotification('æç¤º', 'æš‚æ— è®¢é˜…éœ€è¦æ£€æµ‹', 'info');
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    icon.style.animation = '';
                    showNotification('é”™è¯¯', 'è·å–è®¢é˜…åˆ—è¡¨å¤±è´¥: ' + error.message, 'danger');
                });
        }
        
        function checkSubscriptionsSequentially(subscriptions, index, btn, originalText, icon, results) {
            if (index >= subscriptions.length) {
                // æ‰€æœ‰è®¢é˜…æ£€æµ‹å®Œæˆ
                btn.disabled = false;
                btn.innerHTML = originalText;
                icon.style.animation = '';
                loadSubscriptions();
                
                // ç”Ÿæˆç»“æœæ¶ˆæ¯
                let message = `å·²å®Œæˆ ${subscriptions.length} ä¸ªè®¢é˜…çš„æ£€æµ‹\n\n`;
                
                if (results.success.length > 0) {
                    message += `âœ… æˆåŠŸ: ${results.success.length} ä¸ª\n`;
                }
                
                if (results.failed.length > 0) {
                    message += `\nâŒ Cookie è¿‡æœŸ: ${results.failed.length} ä¸ª\n`;
                    results.failed.forEach(item => {
                        message += `  â€¢ #${item.order} ${item.name}\n`;
                    });
                    message += `\nè¯·å‰å¾€è®¾ç½®é¡µé¢æ›´æ–°è¿™äº›è®¢é˜…çš„ Cookie`;
                }
                
                const notificationType = results.failed.length > 0 ? 'warning' : 'success';
                showNotification('æ£€æµ‹å®Œæˆ', message, notificationType);
                return;
            }
            
            const sub = subscriptions[index];
            console.log(`æ£€æµ‹è®¢é˜… ${index + 1}/${subscriptions.length}: ${sub.name}`);
            
            // æ£€æµ‹å½“å‰è®¢é˜…
            fetch(`/api/subscriptions/${sub.id}/check`, {
                method: 'POST'
            })
            .then(response => {
                // å…ˆæ£€æŸ¥ HTTP çŠ¶æ€ç 
                if (response.status === 400) {
                    // Cookie è¿‡æœŸæˆ–è®¤è¯å¤±è´¥
                    results.failed.push({
                        order: sub.order || index + 1,
                        name: sub.name
                    });
                    // ç»§ç»­æ£€æµ‹ä¸‹ä¸€ä¸ª
                    setTimeout(() => {
                        checkSubscriptionsSequentially(subscriptions, index + 1, btn, originalText, icon, results);
                    }, 500);
                    return Promise.resolve(); // è¿”å›ä¸€ä¸ªå·²è§£å†³çš„ Promise
                } else {
                    return response.json().then(result => {
                        if (result.success) {
                            results.success.push({
                                order: sub.order || index + 1,
                                name: sub.name
                            });
                        } else {
                            results.failed.push({
                                order: sub.order || index + 1,
                                name: sub.name
                            });
                        }
                        // ç»§ç»­æ£€æµ‹ä¸‹ä¸€ä¸ª
                        setTimeout(() => {
                            checkSubscriptionsSequentially(subscriptions, index + 1, btn, originalText, icon, results);
                        }, 500);
                    });
                }
            })
            .catch(error => {
                console.error(`æ£€æµ‹è®¢é˜… ${sub.name} å¤±è´¥:`, error);
                // ç½‘ç»œé”™è¯¯æˆ– JSON è§£æé”™è¯¯ï¼Œå¾ˆå¯èƒ½æ˜¯ Cookie è¿‡æœŸ
                results.failed.push({
                    order: sub.order || index + 1,
                    name: sub.name
                });
                // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­æ£€æµ‹ä¸‹ä¸€ä¸ª
                setTimeout(() => {
                    checkSubscriptionsSequentially(subscriptions, index + 1, btn, originalText, icon, results);
                }, 500);
            });
        }
        
        // æ˜¾ç¤ºé€šçŸ¥æ¨¡æ€æ¡†
        function showNotification(title, message, type = 'info') {
            const modal = new bootstrap.Modal(document.getElementById('notificationModal'));
            const header = document.getElementById('notificationHeader');
            const titleEl = document.getElementById('notificationTitle');
            const body = document.getElementById('notificationBody');
            
            // è®¾ç½®æ ‡é¢˜
            titleEl.textContent = title;
            
            // è®¾ç½®æ ·å¼
            header.className = 'modal-header';
            if (type === 'success') {
                header.classList.add('bg-success', 'text-white');
                titleEl.innerHTML = 'âœ… ' + title;
            } else if (type === 'danger' || type === 'error') {
                header.classList.add('bg-danger', 'text-white');
                titleEl.innerHTML = 'âŒ ' + title;
            } else if (type === 'warning') {
                header.classList.add('bg-warning');
                titleEl.innerHTML = 'âš ï¸ ' + title;
            } else {
                header.classList.add('bg-info', 'text-white');
                titleEl.innerHTML = 'â„¹ï¸ ' + title;
            }
            
            // è®¾ç½®å†…å®¹
            body.innerHTML = message.replace(/\n/g, '<br>');
            
            modal.show();
        }

        // åˆ›å»ºç”¨æˆ·ç›¸å…³å‡½æ•°
        let createUserModal;
        let viewUsersModal;
        let userResultModal;
        
        document.addEventListener('DOMContentLoaded', function() {
            createUserModal = new bootstrap.Modal(document.getElementById('createUserModal'));
            viewUsersModal = new bootstrap.Modal(document.getElementById('viewUsersModal'));
            userResultModal = new bootstrap.Modal(document.getElementById('userResultModal'));
            
            // ç›‘å¬æ¨¡æ€æ¡†æ‰“å¼€äº‹ä»¶ï¼ŒåŠ è½½è®¢é˜…åˆ—è¡¨
            document.getElementById('createUserModal').addEventListener('show.bs.modal', function() {
                loadSubscriptionsForUser();
            });
        });
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            document.execCommand('copy');
            
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'âœ… å·²å¤åˆ¶';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-secondary');
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        }
        
        // å¤åˆ¶å…¨éƒ¨ç”¨æˆ·ä¿¡æ¯
        function copyAllUserInfo() {
            const username = document.getElementById('resultUsername').value;
            const email = document.getElementById('resultEmail').value;
            const password = document.getElementById('resultPassword').value;
            const license = document.getElementById('resultLicense').value;
            
            const allInfo = `Office 365 ç”¨æˆ·ä¿¡æ¯\n\n` +
                          `ç”¨æˆ·å: ${username}\n` +
                          `é‚®ç®±: ${email}\n` +
                          `å¯†ç : ${password}\n` +
                          `è®¸å¯è¯: ${license}\n\n` +
                          `è¯·å¦¥å–„ä¿ç®¡æ­¤ä¿¡æ¯ï¼`;
            
            // åˆ›å»ºä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
            const textarea = document.createElement('textarea');
            textarea.value = allInfo;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ… å·²å¤åˆ¶å…¨éƒ¨';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-primary');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
            }, 2000);
        }

        function loadSubscriptionsForUser() {
            fetch('/api/subscriptions')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const select = document.getElementById('userSubscription');
                        select.innerHTML = '<option value="">è¯·é€‰æ‹©è®¢é˜…...</option>';
                        
                        result.data.forEach(sub => {
                            // åªæ˜¾ç¤ºé…ç½®äº†ç”¨æˆ·åˆ›å»ºåŠŸèƒ½çš„è®¢é˜…
                            if (sub.user_create_config) {
                                const option = document.createElement('option');
                                option.value = sub.id;
                                option.textContent = `#${sub.order} - ${sub.name}`;
                                select.appendChild(option);
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½è®¢é˜…å¤±è´¥:', error);
                });
        }

        function createUser() {
            const subscriptionId = document.getElementById('userSubscription').value;
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('userPassword').value.trim();

            if (!subscriptionId) {
                showNotification('æç¤º', 'è¯·é€‰æ‹©è®¢é˜…', 'warning');
                return;
            }

            if (!username) {
                showNotification('æç¤º', 'è¯·è¾“å…¥ç”¨æˆ·å', 'warning');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>åˆ›å»ºä¸­...';

            fetch('/api/users/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subscription_id: subscriptionId,
                    username: username,
                    password: password || null
                })
            })
            .then(response => response.json())
            .then(result => {
                btn.disabled = false;
                btn.innerHTML = originalText;

                if (result.success) {
                    const userData = result.data;
                    
                    // å¡«å……ç»“æœæ¨¡æ€æ¡†
                    document.getElementById('resultUsername').value = userData.username || '';
                    document.getElementById('resultEmail').value = userData.user_principal_name || '';
                    document.getElementById('resultPassword').value = userData.password || password || '';
                    document.getElementById('resultLicense').value = userData.licenses_info || 'å·²åˆ†é…';
                    
                    // å…³é—­åˆ›å»ºæ¨¡æ€æ¡†ï¼Œæ˜¾ç¤ºç»“æœæ¨¡æ€æ¡†
                    createUserModal.hide();
                    document.getElementById('createUserForm').reset();
                    
                    // å»¶è¿Ÿæ˜¾ç¤ºç»“æœæ¨¡æ€æ¡†ï¼Œç¡®ä¿åˆ›å»ºæ¨¡æ€æ¡†å®Œå…¨å…³é—­
                    setTimeout(() => {
                        userResultModal.show();
                    }, 300);
                } else {
                    showNotification('åˆ›å»ºå¤±è´¥', result.error, 'danger');
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                showNotification('åˆ›å»ºå¤±è´¥', error.message, 'danger');
            });
        }

        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰è®¢é˜…ID
        let currentSubscriptionId = null;
        
        // æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·æ¿€æ´»ä¿¡æ¯
        let allActivationModal;
        
        function queryAllActivation() {
            if (!allActivationModal) {
                allActivationModal = new bootstrap.Modal(document.getElementById('allActivationModal'));
            }
            
            if (!currentSubscriptionId) {
                showNotification('é”™è¯¯', 'æ— æ³•è·å–è®¢é˜…ä¿¡æ¯', 'danger');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('allActivationLoadingState').style.display = 'block';
            document.getElementById('allActivationContent').style.display = 'none';
            document.getElementById('allActivationErrorState').style.display = 'none';
            
            allActivationModal.show();
            
            // æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·æ¿€æ´»ä¿¡æ¯
            fetch(`/api/users/activation/all/${currentSubscriptionId}`)
                .then(response => response.json())
                .then(result => {
                    document.getElementById('allActivationLoadingState').style.display = 'none';
                    
                    if (result.success) {
                        const usersData = result.data.users_with_activation;
                        const totalUsers = result.data.total_users;
                        const usersWithActivationCount = result.data.users_with_activation_count;
                        
                        // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                        let totalComputers = 0;
                        let totalDevices = 0;
                        
                        usersData.forEach(userData => {
                            totalComputers += userData.activation_info.active_computers || 0;
                            totalDevices += userData.activation_info.active_devices || 0;
                        });
                        
                        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼ˆæ˜¾ç¤ºæœ‰æ¿€æ´»è®¾å¤‡çš„ç”¨æˆ·æ•°ï¼‰
                        document.getElementById('allTotalUsers').textContent = usersWithActivationCount;
                        document.getElementById('allTotalComputers').textContent = totalComputers;
                        document.getElementById('allTotalDevices').textContent = totalDevices;
                        
                        // æ˜¾ç¤ºç”¨æˆ·æ¿€æ´»åˆ—è¡¨
                        const listContainer = document.getElementById('allActivationList');
                        if (usersData.length > 0) {
                            listContainer.innerHTML = usersData.map((userData, index) => {
                                const userInfo = userData.user_info;
                                const activationInfo = userData.activation_info;
                                const machines = activationInfo.machines || [];
                                
                                const machinesHtml = machines.length > 0 ? machines.map((machine, idx) => {
                                    const statusIcon = machine.license_status_code === 1 ? 'âœ…' : 'âŒ';
                                    return `
                                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                            <div>
                                                <small><strong>${machine.machine_name}</strong></small><br>
                                                <small class="text-muted">${machine.machine_os} | ${machine.machine_type}</small>
                                            </div>
                                            <span class="badge ${machine.license_status_code === 1 ? 'bg-success' : 'bg-danger'}">
                                                ${statusIcon} ${machine.license_status}
                                            </span>
                                        </div>
                                    `;
                                }).join('') : '<p class="text-muted text-center py-2">æš‚æ— æ¿€æ´»è®¾å¤‡</p>';
                                
                                return `
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>${index + 1}. ${userInfo.display_name}</strong>
                                                    <br>
                                                    <small class="text-muted">${userInfo.user_principal_name}</small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-primary me-1">
                                                        ğŸ’» ${activationInfo.active_computers} / ${activationInfo.total_computers}
                                                    </span>
                                                    <span class="badge bg-info">
                                                        ğŸ“± ${activationInfo.active_devices} / ${activationInfo.total_devices}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            ${machinesHtml}
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        } else {
                            listContainer.innerHTML = '<p class="text-muted text-center py-3">æš‚æ— ç”¨æˆ·æ¿€æ´»ä¿¡æ¯</p>';
                        }
                        
                        document.getElementById('allActivationContent').style.display = 'block';
                    } else {
                        document.getElementById('allActivationErrorState').style.display = 'block';
                        document.getElementById('allActivationErrorState').textContent = `æŸ¥è¯¢å¤±è´¥: ${result.error}`;
                    }
                })
                .catch(error => {
                    document.getElementById('allActivationLoadingState').style.display = 'none';
                    document.getElementById('allActivationErrorState').style.display = 'block';
                    document.getElementById('allActivationErrorState').textContent = `æŸ¥è¯¢å¤±è´¥: ${error.message}`;
                });
        }
        
        // æŸ¥è¯¢ç”¨æˆ·æ¿€æ´»ä¿¡æ¯
        let activationModal;
        
        function queryActivation(subscriptionId, username, displayName) {
            if (!activationModal) {
                activationModal = new bootstrap.Modal(document.getElementById('activationModal'));
            }
            
            document.getElementById('activationTitle').textContent = `ğŸ“± ${displayName} - Office 365 æ¿€æ´»ä¿¡æ¯`;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('activationLoadingState').style.display = 'block';
            document.getElementById('activationContent').style.display = 'none';
            document.getElementById('activationErrorState').style.display = 'none';
            
            activationModal.show();
            
            // æŸ¥è¯¢æ¿€æ´»ä¿¡æ¯
            fetch(`/api/users/activation/${subscriptionId}/${username}`)
                .then(response => response.json())
                .then(result => {
                    document.getElementById('activationLoadingState').style.display = 'none';
                    
                    if (result.success) {
                        const userInfo = result.data.user_info;
                        const activationInfo = result.data.activation_info;
                        
                        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                        document.getElementById('actUserName').textContent = userInfo.display_name;
                        document.getElementById('actUserEmail').textContent = userInfo.user_principal_name;
                        
                        // æ˜¾ç¤ºæ¿€æ´»ç»Ÿè®¡
                        document.getElementById('actComputers').textContent = 
                            `${activationInfo.active_computers} / ${activationInfo.total_computers}`;
                        document.getElementById('actDevices').textContent = 
                            `${activationInfo.active_devices} / ${activationInfo.total_devices}`;
                        
                        // æ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨
                        const machinesList = document.getElementById('machinesList');
                        if (activationInfo.machines && activationInfo.machines.length > 0) {
                            machinesList.innerHTML = activationInfo.machines.map((machine, index) => {
                                const statusIcon = machine.license_status_code === 1 ? 'âœ…' : 'âŒ';
                                const statusClass = machine.license_status_code === 1 ? 'success' : 'danger';
                                
                                // æ ¼å¼åŒ–æ—¶é—´
                                let formattedTime = 'æœªçŸ¥';
                                if (machine.last_license_requested) {
                                    try {
                                        const date = new Date(machine.last_license_requested);
                                        formattedTime = date.toLocaleString('zh-CN');
                                    } catch (e) {
                                        formattedTime = machine.last_license_requested;
                                    }
                                }
                                
                                return `
                                    <div class="card mb-2">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-2">
                                                        <span class="badge bg-dark me-2">${index + 1}</span>
                                                        ${machine.machine_name}
                                                    </h6>
                                                    <p class="mb-1 text-muted small">
                                                        <strong>æ“ä½œç³»ç»Ÿ:</strong> ${machine.machine_os}
                                                    </p>
                                                    <p class="mb-1 text-muted small">
                                                        <strong>è®¾å¤‡ç±»å‹:</strong> ${machine.machine_type}
                                                    </p>
                                                    <p class="mb-0 text-muted small">
                                                        <strong>æœ€åè¯·æ±‚:</strong> ${formattedTime}
                                                    </p>
                                                </div>
                                                <div>
                                                    <span class="badge bg-${statusClass}" style="font-size: 1rem; padding: 0.5rem 0.75rem;">
                                                        ${statusIcon} ${machine.license_status}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        } else {
                            machinesList.innerHTML = '<p class="text-muted text-center py-3">æš‚æ— æ¿€æ´»è®¾å¤‡</p>';
                        }
                        
                        document.getElementById('activationContent').style.display = 'block';
                    } else {
                        document.getElementById('activationErrorState').style.display = 'block';
                        document.getElementById('activationErrorState').textContent = `æŸ¥è¯¢å¤±è´¥: ${result.error}`;
                    }
                })
                .catch(error => {
                    document.getElementById('activationLoadingState').style.display = 'none';
                    document.getElementById('activationErrorState').style.display = 'block';
                    document.getElementById('activationErrorState').textContent = `æŸ¥è¯¢å¤±è´¥: ${error.message}`;
                });
        }

        // æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
        function viewUsers(subscriptionId, subscriptionName) {
            // ä¿å­˜å½“å‰è®¢é˜…IDï¼Œä¾›æ‰¹é‡æŸ¥è¯¢ä½¿ç”¨
            currentSubscriptionId = subscriptionId;
            
            document.getElementById('viewUsersTitle').textContent = `ğŸ‘¥ ${subscriptionName} - ç”¨æˆ·åˆ—è¡¨`;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('usersLoadingState').style.display = 'block';
            document.getElementById('usersListContainer').style.display = 'none';
            document.getElementById('usersErrorState').style.display = 'none';
            
            viewUsersModal.show();
            
            // åŠ è½½ç”¨æˆ·åˆ—è¡¨
            fetch(`/api/users/list/${subscriptionId}`)
                .then(response => response.json())
                .then(result => {
                    document.getElementById('usersLoadingState').style.display = 'none';
                    
                    if (result.success) {
                        const users = result.data.users;
                        const totalCount = result.data.total_count;
                        
                        if (users.length === 0) {
                            document.getElementById('usersErrorState').style.display = 'block';
                            document.getElementById('usersErrorState').textContent = 'æš‚æ— ç”¨æˆ·';
                            document.getElementById('usersErrorState').className = 'alert alert-info';
                            return;
                        }
                        
                        // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
                        const tbody = document.getElementById('usersTableBody');
                        tbody.innerHTML = users.map(user => {
                            const licenseIcon = user.has_license ? 'âœ…' : 'âŒ';
                            const statusBadge = user.signin_status === 'Allowed' 
                                ? '<span class="badge bg-success">å…è®¸ç™»å½•</span>' 
                                : '<span class="badge bg-danger">ç¦æ­¢ç™»å½•</span>';
                            
                            // æå–ç”¨æˆ·åï¼ˆé‚®ç®±@å‰é¢çš„éƒ¨åˆ†ï¼‰
                            const username = user.user_principal_name ? user.user_principal_name.split('@')[0] : user.display_name;
                            
                            return `
                                <tr>
                                    <td><strong>${user.display_name || '-'}</strong></td>
                                    <td>${user.user_principal_name || '-'}</td>
                                    <td>${licenseIcon} ${user.licenses || 'æ— '}</td>
                                    <td>${statusBadge}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info" 
                                                onclick="queryActivation('${subscriptionId}', '${username}', '${user.display_name}')"
                                                style="border-radius: 8px;">
                                            ğŸ“± æŸ¥è¯¢æ¿€æ´»
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                        
                        document.getElementById('usersTotalCount').textContent = `å…± ${totalCount} ä¸ªç”¨æˆ·`;
                        document.getElementById('usersListContainer').style.display = 'block';
                    } else {
                        document.getElementById('usersErrorState').style.display = 'block';
                        document.getElementById('usersErrorState').textContent = `æŸ¥è¯¢å¤±è´¥: ${result.error}`;
                        document.getElementById('usersErrorState').className = 'alert alert-danger';
                    }
                })
                .catch(error => {
                    document.getElementById('usersLoadingState').style.display = 'none';
                    document.getElementById('usersErrorState').style.display = 'block';
                    document.getElementById('usersErrorState').textContent = `æŸ¥è¯¢å¤±è´¥: ${error.message}`;
                    document.getElementById('usersErrorState').className = 'alert alert-danger';
                });
        }
    </script>
</body>
</html>
