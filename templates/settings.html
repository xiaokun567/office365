<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾ç½® - Office 365 è®¢é˜…ç›‘æ§</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <span style="font-size: 1.5rem;">âš™ï¸</span> Office 365 è®¢é˜…ç›‘æ§ - è®¾ç½®
            </span>
            <div class="d-flex">
                <a href="/" class="btn btn-outline-light btn-sm me-2">
                    <span>ğŸ </span> ä»ªè¡¨æ¿
                </a>
                <a href="/settings" class="btn btn-light btn-sm me-2">
                    <span>âš™ï¸</span> è®¾ç½®
                </a>
                <a href="/logout" class="btn btn-outline-light btn-sm">
                    <span>ğŸšª</span> ç™»å‡º
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- è®¢é˜…ç®¡ç†éƒ¨åˆ† -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ“‹ è®¢é˜…ç®¡ç†</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">
                â• æ·»åŠ è®¢é˜…
            </button>
        </div>

        <div id="subscriptionsList" class="row">
            <!-- è®¢é˜…åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div id="emptyState" class="text-center py-5" style="display: none;">
            <p class="text-muted">æš‚æ— è®¢é˜…é¡¹ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p>
        </div>

        <!-- Webhook é€šçŸ¥é…ç½® -->
        <div class="card mb-4 mt-5">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ğŸ”” Webhook é€šçŸ¥é…ç½®</h5>
            </div>
            <div class="card-body">
                <form id="webhookForm">
                    <div class="mb-3">
                        <label for="webhookUrl" class="form-label">Webhook åœ°å€</label>
                        <input type="url" class="form-control" id="webhookUrl" 
                               placeholder="https://your-webhook-url.com/api/notify">
                        <div class="form-text">é€šçŸ¥å°†å‘é€åˆ°æ­¤åœ°å€</div>
                    </div>
                    <div class="mb-3">
                        <label for="webhookJson" class="form-label">è¯·æ±‚ä½“ JSON æ¨¡æ¿</label>
                        <textarea class="form-control" id="webhookJson" rows="6" 
                                  placeholder='{"title": "{title}", "text": "{é€šçŸ¥æ¶ˆæ¯}"}'></textarea>
                        <div class="form-text">
                            æ”¯æŒçš„å˜é‡ï¼š<br>
                            â€¢ <code>{title}</code> - æ ‡é¢˜ï¼ˆå›ºå®šä¸º"è®¢é˜…ç›‘æ§é€šçŸ¥"ï¼‰<br>
                            â€¢ <code>{content}</code> æˆ– <code>{é€šçŸ¥æ¶ˆæ¯}</code> - é€šçŸ¥å†…å®¹
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="expirationWarningDays" class="form-label">åˆ°æœŸæé†’å¤©æ•°</label>
                        <input type="number" class="form-control" id="expirationWarningDays" 
                               min="1" max="365" value="30">
                        <div class="form-text">
                            å½“è®¢é˜…å‰©ä½™å¤©æ•°å°‘äºæˆ–ç­‰äºæ­¤å¤©æ•°æ—¶ï¼Œå°†å‘é€åˆ°æœŸæé†’é€šçŸ¥ï¼ˆé»˜è®¤30å¤©ï¼‰
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="checkIntervalHours" class="form-label">è‡ªåŠ¨æ£€æµ‹é—´éš”ï¼ˆå°æ—¶ï¼‰</label>
                        <input type="number" class="form-control" id="checkIntervalHours" 
                               min="1" max="168" value="12">
                        <div class="form-text">
                            ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹è®¢é˜…çŠ¶æ€çš„æ—¶é—´é—´éš”ï¼ŒèŒƒå›´ 1-168 å°æ—¶ï¼ˆé»˜è®¤12å°æ—¶ï¼‰
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <strong>ğŸ’¡ é€šçŸ¥è§¦å‘æ¡ä»¶ï¼š</strong>
                        <ul class="mb-0">
                            <li>è®¢é˜…å³å°†åˆ°æœŸï¼ˆå‰©ä½™å¤©æ•° â‰¤ è®¾ç½®çš„æé†’å¤©æ•°ï¼‰</li>
                            <li>è®¢é˜…å·²å¤±æ•ˆ</li>
                            <li>Cookie å¤±æ•ˆï¼ˆè®¤è¯å¤±è´¥ï¼‰</li>
                            <li>ç™»å½•å¯†ç é”™è¯¯</li>
                        </ul>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveWebhookConfig()">
                        ğŸ’¾ ä¿å­˜é…ç½®
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="testWebhook()">
                        ğŸ§ª æµ‹è¯•é€šçŸ¥
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ è®¢é˜…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ·»åŠ è®¢é˜…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addForm">
                        <div class="mb-3">
                            <label for="addOrder" class="form-label">ç¼–å·</label>
                            <input type="number" class="form-control" id="addOrder" min="1" 
                                   placeholder="ç•™ç©ºè‡ªåŠ¨åˆ†é…">
                            <div class="form-text">ç”¨äºæ’åºå’Œå¿«é€ŸæŸ¥è¯¢</div>
                        </div>
                        <div class="mb-3">
                            <label for="addName" class="form-label">è®¢é˜…åç§°</label>
                            <input type="text" class="form-control" id="addName" required 
                                   placeholder="ä¾‹å¦‚: å…¬å¸ Office 365 è®¢é˜…">
                        </div>
                        <div class="mb-3">
                            <label for="addCurlCommand" class="form-label">è®¸å¯è¯æŸ¥è¯¢ Curl å‘½ä»¤</label>
                            <textarea class="form-control" id="addCurlCommand" rows="10" required
                                      placeholder="ç²˜è´´å®Œæ•´çš„ curl å‘½ä»¤..."></textarea>
                            <div class="form-text">ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·å¤åˆ¶è®¸å¯è¯æŸ¥è¯¢çš„ curl å‘½ä»¤</div>
                        </div>
                        <hr class="my-4">
                        <h6 class="mb-3">ç”¨æˆ·åˆ›å»ºé…ç½®ï¼ˆå¯é€‰ï¼‰</h6>
                        <div class="mb-3">
                            <label for="addUserCreateCurl" class="form-label">åˆ›å»ºç”¨æˆ·çš„ Curl å‘½ä»¤</label>
                            <textarea class="form-control" id="addUserCreateCurl" rows="10" 
                                      placeholder="ç²˜è´´åˆ›å»ºç”¨æˆ·çš„å®Œæ•´ curl å‘½ä»¤..."></textarea>
                            <div class="form-text">
                                ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·å¤åˆ¶åˆ›å»ºç”¨æˆ·è¯·æ±‚çš„ curl å‘½ä»¤
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="addSubscription()">æ·»åŠ </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘è®¢é˜…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¼–è¾‘è®¢é˜…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <div class="mb-3">
                            <label for="editOrder" class="form-label">ç¼–å·</label>
                            <input type="number" class="form-control" id="editOrder" min="1" required>
                            <div class="form-text">ç”¨äºæ’åºå’Œå¿«é€ŸæŸ¥è¯¢</div>
                        </div>
                        <div class="mb-3">
                            <label for="editName" class="form-label">è®¢é˜…åç§°</label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editCurlCommand" class="form-label">è®¸å¯è¯æŸ¥è¯¢ Curl å‘½ä»¤</label>
                            <textarea class="form-control" id="editCurlCommand" rows="10" required></textarea>
                            <div class="form-text">ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·å¤åˆ¶è®¸å¯è¯æŸ¥è¯¢çš„ curl å‘½ä»¤</div>
                        </div>
                        <hr class="my-4">
                        <h6 class="mb-3">ç”¨æˆ·åˆ›å»ºé…ç½®ï¼ˆå¯é€‰ï¼‰</h6>
                        <div class="mb-3">
                            <label for="editUserCreateCurl" class="form-label">åˆ›å»ºç”¨æˆ·çš„ Curl å‘½ä»¤</label>
                            <textarea class="form-control" id="editUserCreateCurl" rows="10" 
                                      placeholder="ç²˜è´´åˆ›å»ºç”¨æˆ·çš„å®Œæ•´ curl å‘½ä»¤..."></textarea>
                            <div class="form-text">
                                ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·å¤åˆ¶åˆ›å»ºç”¨æˆ·è¯·æ±‚çš„ curl å‘½ä»¤
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="updateSubscription()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let addModal, editModal;

        document.addEventListener('DOMContentLoaded', function() {
            addModal = new bootstrap.Modal(document.getElementById('addModal'));
            editModal = new bootstrap.Modal(document.getElementById('editModal'));
            loadSubscriptions();
            loadWebhookConfig();
        });

        // Webhook é…ç½®ç›¸å…³
        function loadWebhookConfig() {
            fetch('/api/webhook-config')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        document.getElementById('webhookUrl').value = result.data.webhook_url || '';
                        document.getElementById('webhookJson').value = result.data.webhook_json || '';
                        document.getElementById('expirationWarningDays').value = result.data.expiration_warning_days || 30;
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ Webhook é…ç½®å¤±è´¥:', error);
                });
            
            // åŠ è½½æ£€æµ‹é—´éš”
            fetch('/api/check-interval')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        document.getElementById('checkIntervalHours').value = result.data.check_interval_hours || 12;
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ£€æµ‹é—´éš”å¤±è´¥:', error);
                });
        }

        function saveWebhookConfig() {
            const webhookUrl = document.getElementById('webhookUrl').value.trim();
            const webhookJson = document.getElementById('webhookJson').value.trim();
            const expirationWarningDays = parseInt(document.getElementById('expirationWarningDays').value) || 30;
            const checkIntervalHours = parseInt(document.getElementById('checkIntervalHours').value) || 12;

            // éªŒè¯å¤©æ•°
            if (expirationWarningDays < 1 || expirationWarningDays > 365) {
                alert('âŒ åˆ°æœŸæé†’å¤©æ•°å¿…é¡»åœ¨ 1-365 ä¹‹é—´');
                return;
            }
            
            // éªŒè¯æ£€æµ‹é—´éš”
            if (checkIntervalHours < 1 || checkIntervalHours > 168) {
                alert('âŒ æ£€æµ‹é—´éš”å¿…é¡»åœ¨ 1-168 å°æ—¶ä¹‹é—´');
                return;
            }

            // ä¿å­˜ Webhook é…ç½®
            fetch('/api/webhook-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    webhook_url: webhookUrl,
                    webhook_json: webhookJson,
                    expiration_warning_days: expirationWarningDays
                })
            })
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    throw new Error(result.error || 'ä¿å­˜ Webhook é…ç½®å¤±è´¥');
                }
                
                // ä¿å­˜æ£€æµ‹é—´éš”
                return fetch('/api/check-interval', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        check_interval_hours: checkIntervalHours
                    })
                });
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('âœ… é…ç½®å·²ä¿å­˜ï¼\n\næ£€æµ‹é—´éš”å°†åœ¨ä¸‹æ¬¡æ£€æµ‹æ—¶ç”Ÿæ•ˆã€‚');
                } else {
                    alert('âŒ ä¿å­˜æ£€æµ‹é—´éš”å¤±è´¥: ' + result.error);
                }
            })
            .catch(error => {
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            });
        }

        function testWebhook() {
            const webhookUrl = document.getElementById('webhookUrl').value.trim();
            const webhookJson = document.getElementById('webhookJson').value.trim();
            const expirationWarningDays = parseInt(document.getElementById('expirationWarningDays').value) || 30;

            if (!webhookUrl) {
                alert('è¯·å…ˆå¡«å†™ Webhook åœ°å€');
                return;
            }

            // å…ˆä¿å­˜é…ç½®
            fetch('/api/webhook-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    webhook_url: webhookUrl,
                    webhook_json: webhookJson,
                    expiration_warning_days: expirationWarningDays
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // å‘é€æµ‹è¯•é€šçŸ¥
                    return fetch('/api/webhook-test', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                } else {
                    throw new Error(result.error || 'ä¿å­˜é…ç½®å¤±è´¥');
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('âœ… æµ‹è¯•é€šçŸ¥å·²å‘é€ï¼\n\nè¯·æ£€æŸ¥æ‚¨çš„é€šçŸ¥æ¥æ”¶ç«¯æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯ã€‚');
                } else {
                    alert('âŒ æµ‹è¯•å¤±è´¥: ' + result.error);
                }
            })
            .catch(error => {
                alert('âŒ æµ‹è¯•å¤±è´¥: ' + error.message);
            });
        }

        // è®¢é˜…ç®¡ç†ç›¸å…³
        function loadSubscriptions() {
            fetch('/api/subscriptions')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        displaySubscriptions(result.data);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½è®¢é˜…å¤±è´¥:', error);
                });
        }

        function displaySubscriptions(subscriptions) {
            const container = document.getElementById('subscriptionsList');
            const emptyState = document.getElementById('emptyState');

            if (subscriptions.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = subscriptions.map(sub => createSubscriptionItem(sub)).join('');
        }

        function createSubscriptionItem(sub) {
            const data = sub.subscription_data || {};
            const status = sub.status || 'unknown';
            const order = sub.order || 0;
            
            let statusBadge = '<span class="badge bg-secondary">æœªçŸ¥</span>';
            if (status === 'active') {
                statusBadge = '<span class="badge bg-success">æ´»è·ƒ</span>';
            } else if (status === 'expired') {
                statusBadge = '<span class="badge bg-danger">å¤±æ•ˆ</span>';
            } else if (status === 'error') {
                statusBadge = '<span class="badge bg-warning">é”™è¯¯</span>';
            }

            return `
                <div class="col-12 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-primary me-2" style="font-size: 1rem; padding: 0.5rem 0.75rem;">
                                            #${order}
                                        </span>
                                        <h5 class="card-title mb-0">${sub.name}</h5>
                                        <span class="ms-2">${statusBadge}</span>
                                    </div>
                                    <p class="text-muted mb-1 small">è®¢é˜… ID: ${sub.subscription_id || 'æœªçŸ¥'}</p>
                                    <p class="text-muted mb-0 small">ç±»å‹: ${data.name || data.skuPartNumber || 'æœªçŸ¥'}</p>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editSubscriptionModal('${sub.id}')">
                                        âœï¸ ç¼–è¾‘
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSubscription('${sub.id}')">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function addSubscription() {
            const name = document.getElementById('addName').value;
            const curlCommand = document.getElementById('addCurlCommand').value;
            const order = document.getElementById('addOrder').value;
            const userCreateCurl = document.getElementById('addUserCreateCurl').value;

            if (!name || !curlCommand) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
                return;
            }

            const payload = {
                name: name,
                curl_command: curlCommand
            };

            if (order) {
                payload.order = parseInt(order);
            }

            if (userCreateCurl) {
                payload.user_create_curl = userCreateCurl;
            }

            fetch('/api/subscriptions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('æ·»åŠ æˆåŠŸï¼');
                    addModal.hide();
                    document.getElementById('addForm').reset();
                    loadSubscriptions();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + result.error);
                }
            })
            .catch(error => {
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
            });
        }

        function editSubscriptionModal(subId) {
            fetch('/api/subscriptions')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const sub = result.data.find(s => s.id === subId);
                        if (sub) {
                            document.getElementById('editId').value = sub.id;
                            document.getElementById('editOrder').value = sub.order || 1;
                            document.getElementById('editName').value = sub.name;
                            const curlCommand = `curl '${sub.api_url}' -H 'accept: application/json' -b '${sub.cookies}'`;
                            document.getElementById('editCurlCommand').value = curlCommand;
                            document.getElementById('editUserCreateCurl').value = sub.user_create_curl || '';
                            editModal.show();
                        }
                    }
                });
        }

        function updateSubscription() {
            const id = document.getElementById('editId').value;
            const order = document.getElementById('editOrder').value;
            const name = document.getElementById('editName').value;
            const curlCommand = document.getElementById('editCurlCommand').value;
            const userCreateCurl = document.getElementById('editUserCreateCurl').value;

            if (!name || !curlCommand || !order) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
                return;
            }

            const payload = {
                order: parseInt(order),
                name: name,
                curl_command: curlCommand
            };

            if (userCreateCurl) {
                payload.user_create_curl = userCreateCurl;
            }

            fetch(`/api/subscriptions/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('æ›´æ–°æˆåŠŸï¼');
                    editModal.hide();
                    loadSubscriptions();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + result.error);
                }
            })
            .catch(error => {
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
            });
        }

        function deleteSubscription(subId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢é˜…å—ï¼Ÿ')) {
                return;
            }

            fetch(`/api/subscriptions/${subId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    loadSubscriptions();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.error);
                }
            })
            .catch(error => {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            });
        }
    </script>
</body>
</html>
